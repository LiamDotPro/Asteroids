<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Asteroids</title>

    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

</head>
<body>
    <h1 id="id"></h1>
    <div id="controls"><h1>Enter</h1></div>
    <div id="lobbies">
        <div id="lobbyRow" class="row lobbyRow">

        </div>
    </div>
    <div class="userLobby">
        <div id="lobby">
            <h1>Currently Connected Users:</h1>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div id="canvas"></div>
        </div>
    </div>

    <div>

    </div>

    <script type="text/javascript" src="/src/Canvas.js"></script>
    <script type="text/javascript" src="/src/Player.js"></script>
    <script type="text/javascript" src="/src/localGame.js"></script>
    <script>
        var socket = io();
        var canvasobj;
        var canvas;
        var canvasElem = document.getElementById('canvas');
        var lobbyTag = document.getElementById("lobbies");
        var controlsTag = document.getElementById("controls");
        var selectedID = "";
        //setup of how the canvas should look at the beginning and setup server -> client handshake and information
        socket.on('onconnected', function (data) {
            var playerobj = new player(data.id, socket);
            $("#id").text("Client: " + data.id);
            //get canvas object
            canvasobj = new Canvas(playerobj, socket);

            //Hide Elements early incase of network strain
            $('#lobbies').css("display", 'none');
            $('.userLobby').css("display", 'none');

            //programitcally create canvas element and get values from canvas class
            canvas = document.getElementById('canvas').appendChild(canvasobj.createCanvas("front menu"));
            canvasobj.modifyCanvas(canvas, "front menu");

            $(document).ready(function () {
                $("#controls h1").click(function () {
                    //tells the server client has entered
                    socket.emit('enterClicked', {
                    });

                    //unbind old event
                    $("#controls h1").unbind();

                    //binds new event buttons as delegates
                    document.getElementById("controls").addEventListener("click", function (e) {
                        if (e.target && e.target.id === "createLobbyBtn") {
                            console.log("Player attempting to create a lobby");

                            canvasobj.getPlayer().playerCreateALobby();
                        }
                    });
                });

            });
        });

        //Notifys client location has been updated
        socket.on('movedToLobby', function (data) {
            canvasobj.modifyCanvas(canvas, "lobby menu");
            canvasobj.getPlayer().serverClientLocation("lobby menu");
            //empties the div of all nodes
            $('#lobbies').css('display', '');
            $("#controls").empty();
            var createLobby = "<input class='btn btn-default' id='createLobbyBtn' value='Create Lobby' />"
            $('#controls').append(createLobby);

            //This stops clients from being pushed lobbies that may have been added while on loading screen.
            var assignedArray = getListOfAssigneLobbies();

            //at this point the lobby has been built check for any open games
            for (var i = 0; i < data.arrOfLobbies.length; i++) {
                console.log(data.arrOfLobbies[i][0]);
                if (!assignedArray.includes(data.arrOfLobbies[i][0])) {
                    $(".lobbyRow").append("<div class='col-xs-3 lobbyTile'><div id='" + data.arrOfLobbies[i][0] + "' class='lobbyDiv'><h5>ID:" + data.arrOfLobbies[i][0] + " </h5><h5>Players: " + data.arrOfLobbies[i][1] + "</h5> <input class='btn btn-default joinLobbyBtn' value='Join' /></div></div>");
                }
            }

            //add event listeners for the lobbys
            document.getElementById("lobbyRow").addEventListener("click", function (e) {
                if (e.target.classList.contains("joinLobbyBtn")) {
                    var targetID = e.target.parentElement.id;
                    targetID = targetID.toString();
                    console.log(targetID);

                    socket.emit('joinLobby', {
                        lobbyID: targetID
                    });

                }
            });

        });

        function getListOfAssigneLobbies() {
            var assignedArrayTemp = [];

            var lobbyChildren = document.getElementsByClassName("lobbyDiv");

            for (var i = 0; i < lobbyChildren.length; i++) {
                assignedArrayTemp.push(lobbyChildren[i].id);
            }
            return assignedArrayTemp;
        }

        socket.on('lobbyFull', function () {
            alert("The lobby you tried to join is full!");
        });

        //notifys the user a lobby has been created
        socket.on('lobbyCreated', function (data) {
            canvasobj.lobbyCreated(data.lobbyID, data.players);
            $(".lobbyRow").append("<div  class='col-xs-3 lobbyTile'><div id='" + data.lobbyID + "' class='lobbyDiv'><h5>ID:" + data.lobbyID + " </h5><h5>Players: 1</h5>  <input class='btn btn-default joinLobbyBtn' value='Join' /></div></div>");
        });

        //Notifys client they have joined the lobby
        socket.on('userJoinedLobby', function (data) {
            canvasobj.getPlayer().joinedLobby(data.lobbyID);
            //render the user into the lobby they joined

            lobbyTag.style.display = "none";
            controlsTag.style.display = "none";

            //Logs Clients currently connected to the room
            console.log("users in room:" + data.players);

            for (var i = 0; i < data.players.length; i++) {
                $("#lobby").append("<p id='" + data.players[i] + "'>" + data.players[i] + "</p>");
            }

            $(".userLobby").css("display", "");

            //player has joined a lobby modify the canvas to show the lobby waiting room.
            canvasobj.modifyCanvas(canvas, "game lobby");
            canvasobj.constructUserLobby(canvas, data.players, data.lobbyID);

            console.log("I have successfully joined a lobby!");
        });

        //updates the html dom room when someone joins or leaves a room.
        socket.on('updateLobbyPlayers', function (data) {
            var lobbyDiv = document.getElementById(data.lobbyID);
            lobbyDiv.children[1].innerText = "Players: " + data.players.toString();
        });

        //removes the selected element from the dom.
        socket.on("removeLobby", function (data) {
            $("#" + data.lobbyID).remove();
        });

        //A user has joined the lobby you are in.
        socket.on("UserJoinedYourLobby", function (data) {
            console.log("Player " + data.playerID + " has joined the lobby");
            $("#lobby").append("<p id='" + data.playerID + "'>" + data.playerID + "</p>");
        });

        //player has left a lobby you are connected to.
        socket.on("playerLeftLobby", function (data) {
            console.log("player " + data.playerID + " has left the lobby.");
        });

        //Triggered when you are connected to a lobby and the host leaves.
        socket.on("HostClosedLobby", function (data) {
            console.log("Host closed the lobby you are in!");
        });


    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</body>
</html>
